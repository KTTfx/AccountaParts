{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- User Progress Section -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">Your Progress</h4>
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h5>Level {{ current_user.level }}</h5>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: {{ current_user.progress }}%"></div>
                            </div>
                            <small>{{ current_user.points }} points</small>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="badges-container">
                            {% for badge in current_user.badges %}
                            <span class="badge bg-success me-2" title="{{ badge.description }}">
                                <i class="fas {{ badge.icon }}"></i> {{ badge.name }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Check-in Section -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">Daily Check-in</h4>
                <form action="{{ url_for('daily_checkin') }}" method="post">
                    <div class="mb-3">
                        <label class="form-label">How are you feeling today?</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="mood" value="great" id="mood1">
                            <label class="btn btn-outline-success" for="mood1">üòä</label>
                            
                            <input type="radio" class="btn-check" name="mood" value="good" id="mood2">
                            <label class="btn btn-outline-primary" for="mood2">üôÇ</label>
                            
                            <input type="radio" class="btn-check" name="mood" value="okay" id="mood3">
                            <label class="btn btn-outline-warning" for="mood3">üòê</label>
                            
                            <input type="radio" class="btn-check" name="mood" value="bad" id="mood4">
                            <label class="btn btn-outline-danger" for="mood4">üòî</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message for your partner:</label>
                        <textarea class="form-control" name="message" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Check In</button>
                </form>
                {% if current_user.last_checkin %}
                <div class="mt-2 text-center">
                    <small class="text-muted">Last check-in: {{ current_user.last_checkin.strftime('%Y-%m-%d %H:%M') }}</small>
                    <br>
                    <small class="text-success">Current streak: {{ current_user.checkin_streak }} days</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Goals Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title mb-0">Your Goals</h4>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                        <i class="fas fa-plus"></i> Add Goal
                    </button>
                </div>

                <!-- Goal Filters -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="active">Active</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="completed">Completed</button>
                </div>

                <!-- Goals List -->
                <div class="goals-container">
                    {% for goal in goals %}
                    <div class="card mb-3 goal-card" data-status="{{ 'completed' if goal.completed else 'active' }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">{{ goal.title }}</h5>
                                    <p class="card-text">{{ goal.description }}</p>
                                    <div class="badges">
                                        <span class="badge bg-primary">{{ goal.category.name }}</span>
                                        <span class="badge bg-secondary">{{ goal.difficulty }}/5 Difficulty</span>
                                        {% if goal.streak > 0 %}
                                        <span class="badge bg-success">{{ goal.streak }} Day Streak! üî•</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    {% if not goal.completed %}
                                    <button class="btn btn-success btn-sm" onclick="completeGoal({{ goal.id }})">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-danger btn-sm" onclick="deleteGoal({{ goal.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" action="{{ url_for('add_goal') }}" method="post">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category_id" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Difficulty (1-5)</label>
                        <input type="range" class="form-range" name="difficulty" min="1" max="5" value="3">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Requires Verification</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requires_verification" id="requiresVerification">
                            <label class="form-check-label" for="requiresVerification">
                                Require proof of completion
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addGoalForm" class="btn btn-primary">Add Goal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Goal filtering
    document.querySelectorAll('[data-filter]').forEach(button => {
        button.addEventListener('click', (e) => {
            // Remove active class from all buttons
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            e.target.classList.add('active');
            
            const filter = e.target.dataset.filter;
            document.querySelectorAll('.goal-card').forEach(card => {
                if (filter === 'all' || card.dataset.status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    // Goal completion
    function completeGoal(goalId) {
        fetch(`/complete_goal/${goalId}`, {
            method: 'POST',
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }

    // Goal deletion
    function deleteGoal(goalId) {
        if (confirm('Are you sure you want to delete this goal?')) {
            fetch(`/delete_goal/${goalId}`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }
</script>
{% endblock %}
